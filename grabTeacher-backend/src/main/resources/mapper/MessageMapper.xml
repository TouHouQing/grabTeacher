<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.touhouqing.grabteacherbackend.mapper.MessageMapper">

    <!-- MessageVO结果映射 -->
    <resultMap id="MessageVOResultMap" type="com.touhouqing.grabteacherbackend.model.vo.MessageVO">
        <id column="id" property="id" />
        <result column="title" property="title" />
        <result column="content" property="content" />
        <result column="target_type" property="targetType" />
        <result column="target_type_description" property="targetTypeDescription" />
        <result column="admin_id" property="adminId" />
        <result column="admin_name" property="adminName" />
        <result column="is_active" property="isActive" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <!-- 分页查询消息列表 -->
    <select id="selectMessagePage" resultMap="MessageVOResultMap">
        SELECT 
            m.id,
            m.title,
            m.content,
            m.target_type,
            CASE 
                WHEN m.target_type = 'STUDENT' THEN '学生'
                WHEN m.target_type = 'TEACHER' THEN '教师'
                WHEN m.target_type = 'ALL' THEN '全体'
                ELSE '未知'
            END as target_type_description,
            m.admin_id,
            m.admin_name,
            m.is_active,
            m.created_at,
            m.updated_at
        FROM message m
        <where>
            <if test="query.title != null and query.title != ''">
                AND m.title LIKE CONCAT('%', #{query.title}, '%')
            </if>
            <if test="query.targetType != null">
                AND m.target_type = #{query.targetType}
            </if>
            <if test="query.adminName != null and query.adminName != ''">
                AND m.admin_name LIKE CONCAT('%', #{query.adminName}, '%')
            </if>
            <if test="query.isActive != null">
                AND m.is_active = #{query.isActive}
            </if>
        </where>
        ORDER BY m.created_at DESC
    </select>

    <!-- 根据目标类型查询激活的消息列表 -->
    <select id="selectActiveMessagesByTargetTypes" resultMap="MessageVOResultMap">
        SELECT 
            m.id,
            m.title,
            m.content,
            m.target_type,
            CASE 
                WHEN m.target_type = 'STUDENT' THEN '学生'
                WHEN m.target_type = 'TEACHER' THEN '教师'
                WHEN m.target_type = 'ALL' THEN '全体'
                ELSE '未知'
            END as target_type_description,
            m.admin_id,
            m.admin_name,
            m.is_active,
            m.created_at,
            m.updated_at
        FROM message m
        WHERE m.is_active = 1
        AND m.target_type IN
        <foreach collection="targetTypes" item="targetType" open="(" close=")" separator=",">
            #{targetType}
        </foreach>
        ORDER BY m.created_at DESC
        LIMIT #{pageSize} OFFSET #{pageNum}
    </select>

    <!-- 根据目标类型统计激活的消息数量 -->
    <select id="countActiveMessagesByTargetTypes" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM message m
        WHERE m.is_active = 1
        AND m.target_type IN
        <foreach collection="targetTypes" item="targetType" open="(" close=")" separator=",">
            #{targetType}
        </foreach>
    </select>

    <!-- 根据ID查询消息VO -->
    <select id="selectMessageVOById" resultMap="MessageVOResultMap">
        SELECT 
            m.id,
            m.title,
            m.content,
            m.target_type,
            CASE 
                WHEN m.target_type = 'STUDENT' THEN '学生'
                WHEN m.target_type = 'TEACHER' THEN '教师'
                WHEN m.target_type = 'ALL' THEN '全体'
                ELSE '未知'
            END as target_type_description,
            m.admin_id,
            m.admin_name,
            m.is_active,
            m.created_at,
            m.updated_at
        FROM message m
        WHERE m.id = #{id}
    </select>

</mapper>
